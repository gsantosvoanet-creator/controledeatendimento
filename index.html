// A PARTIR DA LINHA ~985
// Função principal para carregar dados (AGORA CARREGA DO FIREBASE)
const loadStats = async () => {
    try {
        // Carrega todos os documentos da coleção 'atendimentos', ordenados por data
        const snapshot = await db.collection("atendimentos").orderBy('date', 'desc').get();
        
        // Mapeia os documentos do Firebase para o array stats.history
        stats.history = snapshot.docs.map(doc => ({
            id: doc.id, 
            ...doc.data()
        }));
        
        // Chamamos a atualização apenas após a coleta bem-sucedida dos dados
        updateAll(); 
        
    } catch (error) {
        console.error("Erro ao carregar dados do Firebase:", error);
        showNotification('Erro ao conectar ou carregar dados do banco de dados.', 5000);
    }
};

// ...
// A PARTIR DA LINHA ~1629
// --- INICIALIZAÇÃO ---
const init = async () => {
    // 1. Carrega as opções de seleção (sincronamente)
    Object.keys(config.selectOptions).forEach(key => {
        const selectId = key;
        const selectEl = getEl(selectId);
        const editSelectEl = getEl(`edit${selectId.charAt(0).toUpperCase() + selectId.slice(1)}`);
        if (selectEl) {
            populateSelect(selectEl, config.selectOptions[key]);
        }
        if (editSelectEl) {
            populateSelect(editSelectEl, config.selectOptions[key]);
        }
    });

    // 2. CHAMA O CARREGAMENTO DE DADOS (Assíncrono)
    await loadStats(); // Força a espera até que os dados estejam em stats.history
};

// Chamada final para iniciar o aplicativo
init();
