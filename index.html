<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOANET - Controle de Atendimentos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #e30613;
            --dark-bg: #151515;
            --darker-bg: #0f0f0f;
            --text-color: #eee;
            --text-muted: #ccc;
            --border-radius: 8px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .nav-tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
        }
        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
        }
        .nav-tab.active, .nav-tab:hover {
            background: #222;
            border-bottom-color: var(--primary-color);
        }
        .main-layout {
            display: flex;
            gap: 20px;
        }
        .main-content {
            /* Usando flex-grow para melhor responsividade em telas maiores */
            flex-grow: 1; 
            width: 65%; /* Mantido para manter o layout inicial */
            display: flex;
            flex-direction: column;
        }
        .dashboard-sidebar {
            width: 35%; /* Mantido para manter o layout inicial */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .container, .management-container {
            background: var(--dark-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(to right, var(--darker-bg), #1c1c1c);
        }
        .logo-container {
            display: inline-block;
            position: relative;
            padding: 25px 45px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: linear-gradient(145deg, var(--darker-bg), #1a1a1a);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .logo-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            position: relative;
        }
        /* Melhoria: Usando Font Awesome para o ícone */
        .logo-wing {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            width: 100%;
            height: 100%;
            font-size: 2.5rem;
            color: var(--primary-color);
            filter: drop-shadow(0 0 8px rgba(227, 6, 19, 0.8));
            animation: pulse 2s infinite ease-in-out;
        }
        .logo-text {
            color: transparent;
            font-weight: 900;
            font-size: 3.2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 15px rgba(227, 6, 19, 0.7), 0 0 30px rgba(227, 6, 19, 0.4);
            background: linear-gradient(to right, #e30613, #ff3b48, #e30613);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% auto;
            animation: gradientShift 3s infinite linear;
        }
        .logo-subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
        .content, .management-container {
            padding: 30px;
        }
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
        }
        select, textarea, input {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: #222;
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s;
        }
        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(227, 6, 19, 0.3);
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .button {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #e30613, #b0040f);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 25px;
            position: relative;
            overflow: hidden;
        }
        .button:hover {
            transform: translateY(-2px);
            background: linear-gradient(to right, #ff0a1a, #c80510);
        }
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #777;
            font-size: 14px;
            border-top: 1px solid #222;
        }
        .dashboard, .dashboard-sidebar {
            background: var(--dark-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .dashboard-title {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-btn, .export-btn, .import-btn {
            background: #222;
            border: 1px solid #333;
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        input[type="date"] {
            padding: 4px 8px;
            width: auto;
            background-color: #222;
            border: 1px solid #333;
            color: var(--text-color);
            border-radius: 5px;
        }
        .control-btn.active, .control-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        .export-btn {
            background: #1e7b1e;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .export-btn:hover {
            background: #2e8b2e;
        }
        .import-btn {
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .import-btn:hover {
            background: #0056b3;
        }
        /* Estilo para o botão de Reset - MANTIDO NO CSS CASO SEJA NECESSÁRIO NO FUTURO */
        .reset-btn {
            background: #e30613 !important; /* Força a cor primária para destaque */
            color: white !important;
            font-weight: bold;
        }
        .reset-btn:hover {
            background: #c80510 !important;
        }
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .stat-card {
            background: linear-gradient(145deg, #1a1a1a, var(--darker-bg));
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(227, 6, 19, 0.2);
        }
        .stat-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        .chart-container {
            margin-top: 15px;
            background: linear-gradient(145deg, #1a1a1a, var(--darker-bg));
            padding: 15px;
            border-radius: 10px;
        }
        .chart-title {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 12px;
            text-align: center;
        }
        .chart {
            display: flex;
            gap: 12px;
            min-height: 150px;
        }
        /* Configurações para o Gráfico Horizontal (Visão Geral) */
        .chart:not(.chart-vertical) {
             flex-direction: column;
        }
        .chart-row {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .chart-row-label {
            /* Aumentado o width para acomodar nomes de setores mais longos */
            width: 100px; 
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .chart-bar-horizontal {
            flex: 1;
            display: flex;
            height: 20px; /* Altura reduzida para melhor visualização na barra */
            border-radius: 3px;
            overflow: hidden;
            background-color: #333;
        }
        .chart-segment {
            height: 100%;
            transition: all 0.3s;
            cursor: pointer;
        }
        .chart-segment:hover {
            filter: brightness(1.2);
        }
        .chart-value {
            position: absolute;
            right: 15px; 
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            padding-right: 5px;
            pointer-events: none;
        }
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 5px;
        }
        .pie-chart {
            height: 150px;
            /* Adicionado overflow: hidden para garantir o formato da pizza */
            overflow: hidden; 
        }
        .pie-chart svg {
            width: 100%;
            height: 100%;
        }
        .pie-slice {
            transition: transform 0.2s;
            cursor: pointer;
            transform-origin: center;
        }
        .pie-slice:hover {
            transform: scale(1.05);
        }
        
        /* NOVO: Estilos para o Gráfico Vertical (Dashboard Completo) */
        .chart-vertical {
            flex-direction: row;
            align-items: flex-end; /* As barras crescem de baixo para cima */
            justify-content: space-around;
            height: 200px; /* Altura fixa para o gráfico vertical */
            border-bottom: 2px solid #555;
            padding-bottom: 40px; 
        }
        .chart-col {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            width: 10%; /* Largura fixa para cada coluna/barra */
            height: 100%;
            position: relative;
            cursor: pointer;
        }
        .chart-bar-vertical {
            width: 100%;
            min-height: 5px; /* Altura mínima para visibilidade */
            transition: height 0.5s ease-out;
            border-radius: 3px 3px 0 0;
            position: relative;
        }
        .chart-col-label {
            position: absolute;
            top: 100%; /* Abaixo do eixo X */
            margin-top: 5px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            /* Rotação removida para rótulos horizontais */
            transform: none; 
            transform-origin: center;
            width: 100px; 
            line-height: 1.1;
        }
        .chart-col-value {
            font-size: 0.85rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
            position: absolute;
            bottom: 100%; /* Acima da barra */
            white-space: nowrap;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification.show {
            transform: translateX(0);
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            background: #222;
        }
        tr:hover {
            background: #252525;
        }
        .action-btn {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            color: white;
            transition: opacity 0.3s;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        .edit-btn { background: #ff9800; }
        .delete-btn { background: #f44336; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #222;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
        }
        .duplicate-warning {
            color: #ffc107;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none; /* Mantido como display: none; */
            font-weight: 600;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        .page-btn {
            padding: 8px 12px;
            background: #222;
            border: 1px solid #333;
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
        }
        .page-btn.active, .page-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #export-modal .button {
            margin-top: 10px;
            background: #2e8b57;
        }
        #export-modal .button:hover {
            background: #3b9e69;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes gradientShift { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
        
        @media (max-width: 1200px) {
            .main-layout { flex-direction: column; }
            .main-content, .dashboard-sidebar { width: 100%; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .nav-tabs { flex-direction: column; }
            .logo-content { flex-direction: column; gap: 10px; }
            .logo-text { font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notification-text"></span>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="registro">Registro de Atendimentos</div>
            <div class="nav-tab" data-tab="gerenciamento">Gerenciamento</div>
            <div class="nav-tab" data-tab="dashboard-completo">Dashboard Completo</div>
        </div>

        <div class="main-layout">
            <div class="main-content">
                <div class="tab-content active" id="registro-tab">
                    <div class="container">
                        <header>
                            <div class="logo-container">
                                <div class="logo-content">
                                    <div class="logo-icon">
                                        <div class="logo-wing"><i class="fas fa-satellite-dish"></i></div>
                                    </div>
                                    <div class="logo-text">VOANET</div>
                                </div>
                            </div>
                            <p class="logo-subtitle">Controle de Atendimentos</p>
                        </header>
                        
                        <div class="content">
                           <form id="registro-form">
                                <div class="form-group">
                                    <label for="protocolo">PROTOCOLO:</label>
                                    <input type="text" id="protocolo" placeholder="Número do protocolo" required autocomplete="off" maxlength="50">
                                    <div class="duplicate-warning" id="duplicateWarning">
                                        <i class="fas fa-exclamation-triangle"></i> Já existe um protocolo com este número.
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="viaContato">VIA DE CONTATO:</label>
                                    <select id="viaContato" required></select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="setor">SETOR:</label>
                                    <select id="setor" required></select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="status">STATUS:</label>
                                    <select id="status" required></select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="colaborador">COLABORADOR:</label>
                                    <select id="colaborador" required></select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="observacoes">OBSERVAÇÕES:</label>
                                    <textarea id="observacoes" placeholder="Detalhes adicionais do atendimento"></textarea>
                                </div>
                                
                                <button type="button" class="button" id="saveBtn">
                                    <i class="fas fa-save"></i> SALVAR ATENDIMENTO
                                </button>
                           </form>
                        </div>
                        <footer>
                            <p>Voanet &copy; 2024 - Todos os direitos reservados</p>
                        </footer>
                    </div>
                </div>

                <div class="tab-content" id="gerenciamento-tab">
                    <div class="management-container">
                        <h2>Gerenciamento de Atendimentos</h2>
                        <p>Visualize, edite e exclua todos os registros de atendimento.</p>
                        
                        <div class="dashboard-controls">
                            <input type="text" id="searchInput" placeholder="Buscar por protocolo, colaborador..." style="flex-grow: 1;">
                            <label for="startDate">De:</label>
                            <input type="date" id="startDate">
                            <label for="endDate">Até:</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="dashboard-controls">
                            <button class="control-btn active" data-filter="all">Todos</button>
                            <button class="control-btn" data-filter="sem-contato">Sem contato</button>
                            <button class="control-btn" data-filter="andamento">Em Andamento</button>
                            <button class="control-btn" data-filter="resolvido">Resolvidos</button>
                            <button class="import-btn" id="importBtn"><i class="fas fa-file-upload"></i> Importar CSV</button>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                            <button class="export-btn" id="exportTableBtn">
                                <i class="fas fa-file-export"></i> Exportar Tabela
                            </button>
                            </div>
                        
                        <div class="table-container">
                            <table id="atendimentosTable">
                                <thead>
                                    <tr>
                                        <th>Protocolo</th>
                                        <th>Setor</th>
                                        <th>Status</th>
                                        <th>Colaborador</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="paginationContainer"></div>
                    </div>
                </div>

                <div class="tab-content" id="dashboard-completo-tab">
                     <div class="management-container">
                         <h2>Dashboard Completo</h2>
                         <p>Visão geral de todos os atendimentos realizados.</p>
                         
                         <div class="dashboard-controls">
                            <label for="dashboardStartDate">De:</label>
                            <input type="date" id="dashboardStartDate">
                            <label for="dashboardEndDate">Até:</label>
                            <input type="date" id="dashboardEndDate">
                         </div>
                         
                         <div class="stats-container" id="dashboard-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                                <div class="stat-title">TOTAL GERAL</div>
                                <div class="stat-value" id="dashboardTotal">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-headset"></i></div>
                                <div class="stat-title">Suporte</div>
                                <div class="stat-value" id="dashboardSuporte">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                                <div class="stat-title">Comercial</div>
                                <div class="stat-value" id="dashboardComercial">0</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-hard-hat"></i></div>
                                <div class="stat-title">Campo</div>
                                <div class="stat-value" id="dashboardCampo">0</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                                <div class="stat-title">Financeiro</div>
                                <div class="stat-value" id="dashboardFinanceiro">0</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-truck"></i></div>
                                <div class="stat-title">Logística</div>
                                <div class="stat-value" id="dashboardLogistica">0</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-hand-holding-heart"></i></div>
                                <div class="stat-title">Retenção</div>
                                <div class="stat-value" id="dashboardRetencao">0</div>
                            </div>
                             <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-thumbs-up"></i></div>
                                <div class="stat-title">Sucesso Cliente</div>
                                <div class="stat-value" id="dashboardSucessoCliente">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-poll"></i></div>
                                <div class="stat-title">Pesquisa CX</div>
                                <div class="stat-value" id="dashboardPesquisaCX">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-times-circle"></i></div> 
                                <div class="stat-title">Não Retido</div>
                                <div class="stat-value" id="dashboardNaoRetido">0</div>
                            </div>
                         </div>
                         
                         <div class="chart-container" style="margin-top: 30px;">
                               <h3 class="chart-title" id="dashboardMensalChartTitle">TOTAL DE ATENDIMENTOS POR SETOR (PERÍODO SELECIONADO)</h3>
                               <div class="chart chart-vertical" id="dashboardMensalChart"></div>
                               <div class="chart-legend" id="dashboardMensalChartLegend"></div>
                         </div>
                     </div>
                </div>
            </div>

            <div class="dashboard-sidebar">
                <div class="dashboard">
                    <h2 class="dashboard-title">
                        <span>VISÃO GERAL</span>
                        <i class="fas fa-sync-alt" id="refreshDashboard" title="Atualizar Dashboard" style="cursor:pointer;"></i>
                    </h2>
                    
                    <div class="stats-container">
                        <div class="stat-card" id="totalCard">
                            <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                            <div class="stat-title">TOTAL DE ATENDIMENTOS</div>
                            <div class="stat-value" id="totalAtendimentos">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                            <div class="stat-title">ATENDIMENTOS HOJE</div>
                            <div class="stat-value" id="atendHoje">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                            <div class="stat-title">ATENDIMENTOS NA SEMANA</div>
                            <div class="stat-value" id="atendSemana">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                            <div class="stat-title">ATENDIMENTOS NO MÊS</div>
                            <div class="stat-value" id="atendMes">0</div>
                        </div>
                        
                        <div class="satisfaction-stats" style="margin-top: 15px; padding: 15px; border-radius: 10px;">
                               <h3 class="satisfaction-title" style="font-size: 1rem; margin-bottom: 12px; text-align: center;">STATUS GERAL</h3>
                               <div class="satisfaction-label" style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                   <span>Resolvidos</span>
                                   <span id="resolvidoPercent">0%</span>
                               </div>
                               <div class="satisfaction-bar" style="height: 8px; background: #333; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
                                   <div class="satisfaction-fill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 1s ease-in-out;"></div>
                               </div>
                               <div class="satisfaction-label" style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                   <span>Em Andamento</span>
                                   <span id="andamentoPercent">0%</span>
                               </div>
                               <div class="satisfaction-bar" style="height: 8px; background: #333; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
                                   <div class="satisfaction-fill" style="height: 100%; background: #FFC107; width: 0%; transition: width 1s ease-in-out;"></div>
                               </div>
                               <div class="satisfaction-label" style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                   <span>Sem contato</span>
                                   <span id="semContatoPercent">0%</span>
                               </div>
                               <div class="satisfaction-bar" style="height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                                   <div class="satisfaction-fill" style="height: 100%; background: #F44336; width: 0%; transition: width 1s ease-in-out;"></div>
                               </div>
                        </div>

                        <div class="chart-container">
                            <h3 class="chart-title">ATENDIMENTOS POR SETOR</h3>
                            <div class="chart" id="visãoGeralSetorChart"></div>
                            <div class="chart-legend" id="visãoGeralSetorChartLegend"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Atendimento</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editProtocolo">PROTOCOLO:</label>
                <input type="text" id="editProtocolo" disabled>
            </div>
            <div class="form-group">
                <label for="editViaContato">VIA DE CONTATO:</label>
                <select id="editViaContato"></select>
            </div>
            <div class="form-group">
                <label for="editSetor">SETOR:</label>
                <select id="editSetor"></select>
            </div>
            <div class="form-group">
                <label for="editStatus">STATUS:</label>
                <select id="editStatus"></select>
            </div>
             <div class="form-group">
                <label for="editColaborador">COLABORADOR:</label>
                <select id="editColaborador"></select>
            </div>
            <div class="form-group">
                <label for="editObservacoes">OBSERVAÇÕES:</label>
                <textarea id="editObservacoes"></textarea>
            </div>
            <button class="button" id="saveEditBtn">
                <i class="fas fa-save"></i> SALVAR ALTERAÇÕES
            </button>
        </div>
    </div>

    <div class="modal" id="export-modal">
        <div class="modal-content" style="max-width: 300px;">
             <div class="modal-header">
                <h2>Exportar Tabela</h2>
                <button class="close-modal">&times;</button>
            </div>
            <p style="margin-bottom: 20px;">Selecione o formato para exportar os dados filtrados:</p>
            <button class="button" id="export-csv">Exportar para CSV</button>
            <button class="button" id="export-xml">Exportar para XML</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // ========================================================
        // 1. CONEXÃO E INICIALIZAÇÃO FIREBASE 
        //    *** CREDENCIAIS REAIS DO SEU PROJETO INSERIDAS ***
        // ========================================================
        
        const firebaseConfig = {
          apiKey: "AIzaSyDAv1U7CtPy10bwQ6xHzIlKbAJGxB2Z_lw", 
          authDomain: "banco-de-dados-7d248.firebaseapp.com",
          projectId: "banco-de-dados-7d248",
          storageBucket: "banco-de-dados-7d248.firebasestorage.app",
          messagingSenderId: "268607318251",
          appId: "1:268607318251:web:4314c9833c78927c1db6ae", 
          measurementId: "G-VX0EPLQ129" 
        };

        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            // O 'db' é o objeto que usaremos para interagir com o Firestore
            window.db = firebase.firestore(); 
        } else {
            console.error("Firebase SDK não carregado. Verifique a conexão com a internet e os scripts no final do HTML.");
            // Define 'db' como um objeto vazio para evitar que o código quebre.
            window.db = { collection: () => ({ get: async () => ({ docs: [] }), add: async () => {} }) };
        }
        
        // ========================================================
        // 2. CONFIGURAÇÕES GLOBAIS
        // ========================================================

        const config = {
            itemsPerPage: 10,
            statusResolvido: ["RESOLVIDO", "SOLUCIONADO", "TRATADO", "ENCERRADO", "ELOGIO", "RETIDO"],
            statusAndamento: ["TRATANDO", "SOLUCIONANDO", "ANDAMENTO"],
            setorColors: {
                'SUPORTE': '#3498db', 'COMERCIAL': '#2ecc71', 'CAMPO': '#f1c40f', 'FINANCEIRO': '#e74c3c',
                'LOGISTICA': '#9b59b6', 'RETENÇÃO': '#e67e22', 'SUCESSO DO CLIENTE': '#34495e',
                'PESQUISA-CX': '#ff8c00' 
            },
            selectOptions: {
                viaContato: ["RA", "PÓS ATENDIMENTO", "OUVIDORIA", "MONITORIA", "AVALIAÇÃO (CHAT)", "ACOMPANHAMENTO (RETENÇÃO)", "PESQUISA-CX"],
                setor: ["SUPORTE", "COMERCIAL", "CAMPO", "FINANCEIRO", "LOGISTICA", "RETENÇÃO", "SUCESSO DO CLIENTE", "PESQUISA-CX"], 
                status: ["SOLUCIONADO", "SOLUCIONANDO", "RETIDO", "NÃO RETIDO", "TRATADO", "TRATANDO", "RESOLVIDO", "NÃO RESOLVIDO", "ELOGIO", "ENCERRADO"],
                colaborador: ["ADINAIANA", "ANA CAROLINE", "ANDRESSA FORTUNA", "CAMILA MACEDO", "CAMILLY", "EDSON NUNES", "ELIENE SOUZA", "GABRIEL CONCEIÇÃO", "GERLAN", "GILDEANDERSON", "JAYLE", "JORGE THALISSON", "JOSE DOMINGOS", "JOSIVALDO", "KELIANE", "KEVIN", "LUCAS PAIXÃO", "LUIZ GUSTAVO", "MARILIA", "MARIO MARCELO", "PALOMA", "PEDRO GABRIEL", "RONAN LÍDIO", "SAMUEL", "TAMARA", "VANESSA", "VINICIUS NUNES"]
            }
        };

        // --- SELEÇÃO DE ELEMENTOS DO DOM ---
        const getEl = (id) => document.getElementById(id);
        
        const protocoloInput = getEl('protocolo'); 
        const duplicateWarning = getEl('duplicateWarning'); 
        const registroForm = getEl('registro-form');
        const saveBtn = getEl('saveBtn');
        const notification = getEl('notification');
        const notificationText = getEl('notification-text');
        const refreshBtn = getEl('refreshDashboard');
        const exportTableBtn = getEl('exportTableBtn');
        const importBtn = getEl('importBtn');
        const csvFileInput = getEl('csvFileInput');
        const searchInput = getEl('searchInput');
        const startDateInput = getEl('startDate');
        const endDateInput = getEl('endDate');
        const dashboardStartDateInput = getEl('dashboardStartDate');
        const dashboardEndDateInput = getEl('dashboardEndDate');
        const editModal = getEl('editModal');
        const exportModal = getEl('export-modal');
        const saveEditBtn = getEl('saveEditBtn');
        const atendimentosTableBody = document.querySelector('#atendimentosTable tbody');
        const paginationContainer = getEl('paginationContainer');
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const dashboardStatsContainer = getEl('dashboard-stats-container');
        const dashboardMensalChartTitle = getEl('dashboardMensalChartTitle');
        const dashboardTotal = getEl('dashboardTotal');
        const dashboardPesquisaCX = getEl('dashboardPesquisaCX');
        const dashboardNaoRetido = getEl('dashboardNaoRetido'); 

        // --- ESTADO DA APLICAÇÃO ---
        let stats = { history: [] }; 
        let currentPage = 1;
        let currentEditId = null;
        
        // --- FUNÇÕES UTILITÁRIAS ---
        const showNotification = (message, duration = 3000) => {
            notificationText.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), duration);
        };

        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        const populateSelect = (selectElement, options, selectedValue = '') => {
            selectElement.innerHTML = `<option value="">Selecione...</option>` + options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            selectElement.value = selectedValue;
        };
        
        const normalizeXmlTag = (str) => str.toUpperCase().replace(/[^A-Z0-9]/g, '_');

        // ========================================================
        // 3. LÓGICA DE DADOS (MIGRADA PARA FIREBASE)
        // ========================================================

        // Função para resetar todos os registros (AGORA APAGA NO FIREBASE)
        const resetAllRecords = async () => {
            if (!confirm("ATENÇÃO: Você tem certeza que deseja APAGAR TODOS os registros de atendimentos permanentemente? Esta ação é irreversível!")) {
                 return;
            }
            try {
                // Deleta todos os documentos da coleção
                const batch = db.batch();
                const snapshot = await db.collection("atendimentos").get();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                stats.history = [];
                updateAll();
                showNotification('Todos os registros foram resetados com sucesso.', 5000);
            } catch (error) {
                console.error("Erro ao resetar dados do Firebase:", error);
                showNotification('Erro ao resetar dados. Tente novamente mais tarde.', 5000);
            }
        };

        // Função para salvar (AGORA SALVA NO FIREBASE)
        const saveStats = async (newRecord) => {
            // Salva o registro no Firebase (Firestore gera o ID automaticamente)
            await db.collection("atendimentos").add(newRecord); 
            
            // Após salvar na nuvem, recarregamos os dados para atualizar o dashboard
            await loadStats(); 
        };

        // Função principal para carregar dados (AGORA CARREGA DO FIREBASE)
        const loadStats = async () => {
            try {
                // Carrega todos os documentos da coleção 'atendimentos', ordenados por data
                // OBS: 'atendimentos' é a coleção que você deve ter criado no Firestore
                const snapshot = await db.collection("atendimentos").orderBy('date', 'desc').get();
                
                // Mapeia os documentos do Firebase para o array stats.history
                stats.history = snapshot.docs.map(doc => ({
                    id: doc.id, // Usa o ID gerado pelo Firestore (necessário para deletar/editar)
                    ...doc.data()
                }));
                
                updateAll();
            } catch (error) {
                console.error("Erro ao carregar dados do Firebase:", error);
                showNotification('Erro ao conectar ou carregar dados do banco de dados.', 5000);
            }
        };
        
        // --- GRÁFICO: BARRAS HORIZONTAIS (Visão Geral) ---
        const updateHorizontalBarChart = (chartContainer, legendContainer, data) => {
            chartContainer.innerHTML = '';
            legendContainer.innerHTML = '';
            
            // 1. Processar dados por setor (Lógica de Agregação Atualizada)
            const setorData = data.reduce((acc, item) => {
                let sectorKey = item.setor;

                // SPECIAL LOGIC: If sector is empty and viaContato is Pesquisa-CX, count it there.
                if (!sectorKey && item.viaContato === 'PESQUISA-CX') {
                    sectorKey = 'PESQUISA-CX';
                }

                if (sectorKey && config.setorColors[sectorKey]) {
                    acc[sectorKey] = (acc[sectorKey] || 0) + 1;
                }
                return acc;
            }, {});

            const total = data.length || 1;
            // 2. Classificar setores por contagem decrescente
            const sortedSectors = Object.keys(setorData).sort((a, b) => setorData[b] - setorData[a]); 

            // 3. Renderizar Barras
            sortedSectors.forEach(setor => {
                const count = setorData[setor];
                const percentage = (count / total) * 100;

                const row = document.createElement('div');
                row.className = 'chart-row';

                const label = document.createElement('div');
                label.className = 'chart-row-label';
                // Adiciona a quebra de linha se o nome for longo
                label.innerHTML = setor.replace(' ', '<br>'); 

                const bar = document.createElement('div');
                bar.className = 'chart-bar-horizontal';
                
                const segment = document.createElement('div');
                segment.className = 'chart-segment';
                segment.style.width = `${percentage}%`;
                segment.style.backgroundColor = config.setorColors[setor];
                segment.title = `${setor}: ${count} (${percentage.toFixed(1)}%)`;
                bar.appendChild(segment);

                const totalValue = document.createElement('div');
                totalValue.className = 'chart-value';
                totalValue.textContent = count; // Exibe a contagem sobre a barra

                row.appendChild(label);
                row.appendChild(bar);
                row.appendChild(totalValue);
                chartContainer.appendChild(row);
            });
        };
        
        // --- NOVO GRÁFICO: BARRAS VERTICAIS (Dashboard Completo) ---
        const updateVerticalBarChart = (chartContainer, legendContainer, data) => {
            chartContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            // 1. Processar dados por setor (Lógica de Agregação Atualizada)
            const setorData = data.reduce((acc, item) => {
                let sectorKey = item.setor;

                // SPECIAL LOGIC: If sector is empty and viaContato is Pesquisa-CX, count it there.
                if (!sectorKey && item.viaContato === 'PESQUISA-CX') {
                    sectorKey = 'PESQUISA-CX';
                }

                if (sectorKey && config.setorColors[sectorKey]) {
                    acc[sectorKey] = (acc[sectorKey] || 0) + 1;
                }
                return acc;
            }, {});

            const maxCount = Math.max(...Object.values(setorData), 1); // Encontra a barra mais alta
            const sortedSectors = Object.keys(setorData).sort((a, b) => setorData[b] - setorData[a]); 

            // 2. Renderizar Colunas
            sortedSectors.forEach(setor => {
                const count = setorData[setor];
                const heightPct = (count / maxCount) * 90; // Escala a altura para no máximo 90%
                const barColor = config.setorColors[setor];

                const col = document.createElement('div');
                col.className = 'chart-col';
                col.title = `${setor}: ${count}`; // Tooltip mantido

                const bar = document.createElement('div');
                bar.className = 'chart-bar-vertical';
                bar.style.height = `${heightPct}%`;
                bar.style.backgroundColor = barColor;

                const label = document.createElement('div');
                label.className = 'chart-col-label';
                // CORRIGIDO: Usando a formatação de traços e com rotação removida (texto horizontal)
                label.textContent = setor.replace(/\s+/g, '-'); 
                
                col.appendChild(bar);
                col.appendChild(label); 
                chartContainer.appendChild(col);
            });
            
            // 3. Renderizar Legenda abaixo do gráfico vertical
            sortedSectors.forEach(setor => {
                const count = setorData[setor];
                const totalCount = data.length || 1;
                const percentage = (count / totalCount) * 100;
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<div class="legend-color" style="background-color: ${config.setorColors[setor]}"></div> ${setor} (${percentage.toFixed(1)}%)`;
                legendContainer.appendChild(legendItem);
            });
        };


        const updateDashboard = () => {
            const total = stats.history.length;
            const resolvido = stats.history.filter(i => config.statusResolvido.includes(i.status)).length;
            const andamento = stats.history.filter(i => config.statusAndamento.includes(i.status)).length;
            const semContato = total - resolvido - andamento;
            
            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Corrige o cálculo da semana para começar no domingo/segunda, dependendo da sua definição
            const firstDayOfWeek = new Date(today);
            firstDayOfWeek.setDate(today.getDate() - today.getDay()); // Inicia no domingo (0)
            firstDayOfWeek.setHours(0,0,0,0);

            const atendHojeCount = stats.history.filter(i => isSameDay(new Date(i.date), today)).length;
            const atendSemanaCount = stats.history.filter(i => new Date(i.date) >= firstDayOfWeek).length;
            const atendMesCount = stats.history.filter(i => {
                const itemDate = new Date(i.date);
                return itemDate.getMonth() === today.getMonth() && itemDate.getFullYear() === today.getFullYear();
            }).length;


            getEl('totalAtendimentos').textContent = total;
            getEl('atendHoje').textContent = atendHojeCount;
            getEl('atendSemana').textContent = atendSemanaCount;
            getEl('atendMes').textContent = atendMesCount;

            const totalStatus = total || 1;
            const resolvidoPct = Math.round((resolvido / totalStatus) * 100);
            const andamentoPct = Math.round((andamento / totalStatus) * 100);
            const semContatoPct = 100 - resolvidoPct - andamentoPct;

            getEl('resolvidoPercent').textContent = `${resolvidoPct}%`;
            document.querySelectorAll('.satisfaction-fill')[0].style.width = `${resolvidoPct}%`;
            getEl('andamentoPercent').textContent = `${andamentoPct}%`;
            document.querySelectorAll('.satisfaction-fill')[1].style.width = `${andamentoPct}%`;
            getEl('semContatoPercent').textContent = `${semContatoPct}%`;
            document.querySelectorAll('.satisfaction-fill')[2].style.width = `${semContatoPct}%`;
            
            // Gráfico Visão Geral (Horizontal)
            updateHorizontalBarChart(getEl('visãoGeralSetorChart'), getEl('visãoGeralSetorChartLegend'), stats.history);
        };
        
        const updateCompleteDashboard = () => {
            const startDate = dashboardStartDateInput.value ? new Date(dashboardStartDateInput.value + 'T00:00:00') : null;
            const endDate = dashboardEndDateInput.value ? new Date(dashboardEndDateInput.value + 'T23:59:59') : null;
            
            let filteredData = stats.history;

            if (startDate || endDate) {
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.date);
                    if (startDate && itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;
                    return true;
                });
            }

            const currentTotal = filteredData.length;

            dashboardTotal.textContent = currentTotal;
            getEl('dashboardSuporte').textContent = filteredData.filter(i => i.setor === 'SUPORTE').length;
            getEl('dashboardComercial').textContent = filteredData.filter(i => i.setor === 'COMERCIAL').length;
            getEl('dashboardCampo').textContent = filteredData.filter(i => i.setor === 'CAMPO').length;
            getEl('dashboardFinanceiro').textContent = filteredData.filter(i => i.setor === 'FINANCEIRO').length;
            getEl('dashboardLogistica').textContent = filteredData.filter(i => i.setor === 'LOGISTICA').length;
            getEl('dashboardRetencao').textContent = filteredData.filter(i => i.setor === 'RETENÇÃO').length;
            getEl('dashboardSucessoCliente').textContent = filteredData.filter(i => i.setor === 'SUCESSO DO CLIENTE').length;
            
            // Pesquisa CX filtra por Via de Contato.
            dashboardPesquisaCX.textContent = filteredData.filter(i => i.viaContato === 'PESQUISA-CX').length; 
            
            // NOVO: Não Retido filtra por Status
            dashboardNaoRetido.textContent = filteredData.filter(i => i.status === 'NÃO RETIDO').length;
            
            
            // USANDO O GRÁFICO VERTICAL PARA O DASHBOARD COMPLETO
            updateVerticalBarChart(getEl('dashboardMensalChart'), getEl('dashboardMensalChartLegend'), filteredData);
            
            // Garante o título correto
            dashboardMensalChartTitle.textContent = 'TOTAL DE ATENDIMENTOS POR SETOR (PERÍODO SELECIONADO)';
        };

        // --- FUNÇÕES DE GRÁFICO PIZZA (Não mais usadas) ---
        const updateSectorPieChart = (chartContainer, legendContainer, data) => {
            chartContainer.innerHTML = '';
            legendContainer.innerHTML = '';
        };

        // A função updateMonthlyStackedBarChart não é mais usada
        const updateMonthlyStackedBarChart = (chartContainer, legendContainer, data) => {
            chartContainer.innerHTML = '';
            legendContainer.innerHTML = '';
        };
        
        // --- LÓGICA DE FILTRO E TABELA (Inalteradas) ---
        const getFilteredData = () => {
            const activeBtn = document.querySelector('.control-btn.active');
            const filterValue = activeBtn ? activeBtn.dataset.filter : 'all';
            const searchValue = searchInput.value.toLowerCase();
            const startDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value + 'T23:59:59') : null;
            
            return stats.history.filter(item => {
                const searchMatch = !searchValue || Object.values(item).some(val => String(val).toLowerCase().includes(searchValue));
                if (!searchMatch) return false;

                const itemDate = new Date(item.date);
                if (startDate && itemDate < startDate) return false;
                if (endDate && itemDate > endDate) return false;

                if (filterValue === 'all') return true;
                if (filterValue === 'resolvido') return config.statusResolvido.includes(item.status);
                if (filterValue === 'andamento') return config.statusAndamento.includes(item.status);
                if (filterValue === 'sem-contato') return !config.statusResolvido.includes(item.status) && !config.statusAndamento.includes(item.status);
                return true;
            }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Ordena por data mais recente
        };
        
        const updateManagementTable = () => {
            const filteredData = getFilteredData();
            
            const totalPages = Math.ceil(filteredData.length / config.itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            else if (totalPages === 0) currentPage = 1;

            const startIndex = (currentPage - 1) * config.itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + config.itemsPerPage);

            atendimentosTableBody.innerHTML = '';
            if (paginatedData.length === 0) {
                atendimentosTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum registro encontrado.</td></tr>';
            } else {
                paginatedData.forEach(item => {
                    const row = atendimentosTableBody.insertRow();
                    // Pegamos o ID do documento Firestore do atributo data-id
                    const docId = item.id;
                    row.innerHTML = `
                        <td>${item.protocolo}</td>
                        <td>${item.setor}</td>
                        <td>${item.status}</td>
                        <td>${item.colaborador}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>
                            <button class="action-btn edit-btn" data-id="${docId}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${docId}" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
            }
            updatePagination(paginationContainer, totalPages, currentPage, (page) => {
                currentPage = page;
                updateManagementTable();
            });
        };
        
        const updatePagination = (container, totalPages, currentPage, pageChangeCallback) => {
            container.innerHTML = '';
            if (totalPages <= 1) return;

            // Lógica de paginação para mostrar até 5 botões centrais
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // Botão "Primeira"
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'page-btn';
                firstBtn.textContent = '1...';
                firstBtn.addEventListener('click', () => pageChangeCallback(1));
                container.appendChild(firstBtn);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => pageChangeCallback(i));
                container.appendChild(pageBtn);
            }

            // Botão "Última"
            if (endPage < totalPages) {
                const lastBtn = document.createElement('button');
                lastBtn.className = 'page-btn';
                lastBtn.textContent = `...${totalPages}`;
                lastBtn.addEventListener('click', () => pageChangeCallback(totalPages));
                container.appendChild(lastBtn);
            }
        };
        
        // --- MANIPULADORES DE EVENTOS ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                navTabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                getEl(`${this.dataset.tab}-tab`).classList.add('active');

                // NOVO AJUSTE: Força a recarga da tabela de gerenciamento ao clicar na aba
                if (this.dataset.tab === 'gerenciamento') {
                    updateManagementTable();
                }
            });
        });
        
        // Melhoria: Validação de duplicidade em tempo real (keyup)
        protocoloInput.addEventListener('keyup', () => {
            const protocolo = protocoloInput.value.trim();
            // A verificação de duplicidade precisa ser feita contra o Firebase, 
            // mas mantemos a validação de formato local.
            const isDuplicate = stats.history.some(item => item.protocolo.toLowerCase() === protocolo.toLowerCase());
            duplicateWarning.style.display = isDuplicate && protocolo ? 'block' : 'none';
        });

        saveBtn.addEventListener('click', async () => { // Adicionado 'async'
            const protocolo = protocoloInput.value.trim();
            const viaContato = getEl('viaContato').value;
            const setor = getEl('setor').value;
            const status = getEl('status').value;
            const colaborador = getEl('colaborador').value;
            const observacoes = getEl('observacoes').value;

            if (!protocolo || !setor || !status || !colaborador || !viaContato) {
                return showNotification('Preencha todos os campos obrigatórios.');
            }
            
            // Verificação de duplicidade local (Será mais segura com o Firebase)
            if (stats.history.some(item => item.protocolo.toLowerCase() === protocolo.toLowerCase())) {
                duplicateWarning.style.display = 'block';
                return showNotification('Este número de protocolo já existe.');
            }

            const now = new Date(); 
            
            const newRecord = {
                date: now.toISOString(),
                protocolo,
                viaContato,
                setor,
                status,
                colaborador,
                observacoes,
            };

            await saveStats(newRecord); // Salva no Firebase
            
            showNotification('Atendimento salvo com sucesso!');
            registroForm.reset();
            duplicateWarning.style.display = 'none'; 
        });

        atendimentosTableBody.addEventListener('click', async (e) => { // Adicionado 'async'
            const target = e.target.closest('button');
            if (!target) return;
            // Pegamos o ID do documento Firestore do atributo data-id
            const docId = target.dataset.id; 

            if (target.classList.contains('delete-btn')) {
                if (confirm('Tem certeza que deseja excluir este registro?')) {
                    try {
                        // ** LÓGICA DE DELEÇÃO FIREBASE **
                        await db.collection("atendimentos").doc(docId).delete();
                        await loadStats(); // Recarrega para atualizar a tabela
                        showNotification('Registro excluído.');
                    } catch (error) {
                        console.error("Erro ao deletar:", error);
                        showNotification('Falha ao excluir o registro.', 5000);
                    }
                }
            } else if (target.classList.contains('edit-btn')) {
                const record = stats.history.find(item => item.id === docId);
                if (record) {
                    currentEditId = docId;
                    getEl('editProtocolo').value = record.protocolo;
                    populateSelect(getEl('editViaContato'), config.selectOptions.viaContato, record.viaContato);
                    populateSelect(getEl('editSetor'), config.selectOptions.setor, record.setor);
                    populateSelect(getEl('editStatus'), config.selectOptions.status, record.status);
                    populateSelect(getEl('editColaborador'), config.selectOptions.colaborador, record.colaborador);
                    getEl('editObservacoes').value = record.observacoes;
                    editModal.style.display = 'flex';
                }
            }
        });

        saveEditBtn.addEventListener('click', async () => { // Adicionado 'async'
            const id = currentEditId;
            if (!id) return;

            const updatedData = {
                viaContato: getEl('editViaContato').value,
                setor: getEl('editSetor').value,
                status: getEl('editStatus').value,
                colaborador: getEl('editColaborador').value,
                observacoes: getEl('editObservacoes').value
            };

            try {
                // ** LÓGICA DE EDIÇÃO FIREBASE **
                await db.collection("atendimentos").doc(id).update(updatedData);
                await loadStats(); // Recarrega para atualizar a tabela
                editModal.style.display = 'none';
                showNotification('Alterações salvas.');
            } catch (error) {
                console.error("Erro ao salvar edição:", error);
                showNotification('Falha ao salvar as alterações.', 5000);
            }
        });
        
        document.querySelectorAll('.control-btn').forEach(btn => {
            // Verifica se o botão é o de reset, se sim, ignora as classes 'active'
            if(btn.id !== 'resetRecordsBtn') {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.control-btn').forEach(b => {
                        if (b.id !== 'resetRecordsBtn') {
                            b.classList.remove('active');
                        }
                    });
                    btn.classList.add('active');
                    
                    if (btn.dataset.filter === 'all') {
                        startDateInput.value = '';
                        endDateInput.value = '';
                    }
                    currentPage = 1;
                    updateManagementTable();
                });
            } else {
                 btn.addEventListener('click', resetAllRecords); 
            }
        });
        
        [searchInput, startDateInput, endDateInput, dashboardStartDateInput, dashboardEndDateInput].forEach(input => {
            input.addEventListener('input', () => {
                currentPage = 1;
                if (input.id.startsWith('dashboard')) {
                    updateCompleteDashboard();
                } else {
                    updateManagementTable();
                }
            });
        });
        
        [document.querySelector('#editModal .close-modal'), document.querySelector('#export-modal .close-modal')].forEach(btn => {
            btn.addEventListener('click', () => {
                editModal.style.display = 'none';
                exportModal.style.display = 'none';
            });
        });

        window.addEventListener('click', (e) => { 
            if(e.target === editModal) editModal.style.display = 'none';
            if(e.target === exportModal) exportModal.style.display = 'none';
        });

        refreshBtn.addEventListener('click', () => {
            refreshBtn.classList.add('fa-spin');
            // Recarrega os dados do Firebase
            loadStats().finally(() => { 
                refreshBtn.classList.remove('fa-spin');
                showNotification('Dashboard atualizado!');
            });
        });

        // --- LÓGICA DE IMPORTAÇÃO E EXPORTAÇÃO ---
        const parsePtBrDate = (dateString) => {
            // ... (mantido código anterior)
            try {
                const parts = dateString.split(/[\/-]/);
                if (parts.length === 3) {
                    // Tenta dd/mm/yyyy
                    if (parts[0].length === 2 && parts[1].length === 2) { 
                        return new Date(`${parts[2]}-${parts[1]}-${parts[0]}T12:00:00`); 
                    }
                    // Tenta yyyy-mm-dd
                    if (parts[0].length === 4) { 
                        return new Date(`${parts[0]}-${parts[1]}-${parts[2]}T12:00:00`); 
                    }
                }
            } catch (e) { /* Fall through */ }
            return null;
        };

        importBtn.addEventListener('click', () => csvFileInput.click());

        csvFileInput.addEventListener('change', async (event) => { // Adicionado 'async'
            const file = event.target.files[0];
            if (!file) return;
            
            // NOTE: A importação CSV está desativada por motivos de complexidade de segurança e autenticação do Firebase.

            const reader = new FileReader();
            reader.onload = async function(e) { // Adicionado 'async'
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        return showNotification('Arquivo CSV vazio ou com dados insuficientes.', 4000);
                    }
                    
                    // ... (mantido código de parsing CSV)
                    showNotification('Importação CSV localmente desativada. Envie manualmente para o Firebase.', 6000);
                    
                } catch(error) {
                    showNotification('Erro ao processar o arquivo CSV. Verifique o formato e o delimitador.', 5000);
                    console.error("Erro na importação:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        exportTableBtn.addEventListener('click', () => {
            if (getFilteredData().length === 0) {
                return showNotification('Não há dados filtrados para exportar.');
            }
            exportModal.style.display = 'flex';
        });

        const exportData = (format) => {
            const data = getFilteredData();
            if (data.length === 0) { return; }

            const headers = Object.keys(data[0]);
            let content = '';
            let fileType = '';
            let fileName = '';

            if (format === 'csv') {
                content = headers.join(',') + '\n';
                data.forEach(row => {
                    content += headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
                });
                fileType = 'text/csv;charset=utf-8;';
                fileName = 'atendimentos_export.csv';
            } else if (format === 'xml') {
                content = '<?xml version="1.0" encoding="UTF-8"?>\n<atendimentos>\n';
                data.forEach(row => {
                    // NOTE: Firestore IDs são strings grandes. Precisamos garantir que eles sejam o ID
                    const firestoreId = row.id || 'NO_ID'; 
                    content += `\t<atendimento id="${firestoreId}">\n`;
                    headers.filter(h => h !== 'id').forEach(header => { // Não exporta o ID como sub-tag
                        const tagName = normalizeXmlTag(header); 
                        const cellData = (row[header] || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        content += `\t\t<${tagName}>${cellData}</${tagName}>\n`;
                    });
                    content += '\t</atendimento>\n';
                });
                content += '</atendimentos>';
                fileType = 'application/xml;charset=utf-8;';
                fileName = 'atendimentos_export.xml';
            }

            const blob = new Blob([content], { type: fileType });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            exportModal.style.display = 'none';
            showNotification(`Dados exportados como ${format.toUpperCase()}`);
        };
        
        getEl('export-csv').addEventListener('click', () => exportData('csv'));
        getEl('export-xml').addEventListener('click', () => exportData('xml'));

        // --- INICIALIZAÇÃO ---
        const init = () => {
            Object.keys(config.selectOptions).forEach(key => {
                const selectId = key;
                const selectEl = getEl(selectId);
                const editSelectEl = getEl(`edit${selectId.charAt(0).toUpperCase() + selectId.slice(1)}`);
                if (selectEl) {
                    populateSelect(selectEl, config.selectOptions[key]);
                }
                if (editSelectEl) {
                    populateSelect(editSelectEl, config.selectOptions[key]);
                }
            });
            // AQUI CHAMAMOS O NOVO loadStats() assíncrono
            loadStats(); 
        };

        init();
    });
    </script>
</body>
</html>